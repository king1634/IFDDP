<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="Facility">
    <select id="getCntFacility" resultType="int">
        SELECT count(*) FROM Facility
    </select>
    
    <select id="getAllFacilityAllInfo" resultType="Dto.adg.FacilityDto">
        SELECT f.*, b."CONTENTS" AS "FACILITY_TYPE_KOREAN", f."FACILITY_SCALE" || '종' as "FACILITY_SCALE_KOREAN" 
		FROM facility f
		JOIN bunryu b ON f."FACILITY_TYPE" = b."MCD"
		WHERE b."BCD" = 200;
    </select>
    
    <select id="getAllFacility" resultType="Dto.adg.FacilityDto">
        SELECT * FROM Facility LIMIT ${size} OFFSET ${page}
    </select>
    
    <select id="getSearchFacility" resultType="Dto.adg.FacilityDto">
        SELECT * FROM Facility 
        <choose>
            <when test="facilityDto.searchType == 'FACILITY_ID'">
                WHERE "FACILITY_ID" = CAST(#{facilityDto.searchValue} AS INTEGER)
            </when>
            <when test="facilityDto.searchType == 'FACILITY_NAME'">
                WHERE "FACILITY_NAME" LIKE '%' || #{facilityDto.searchValue} || '%'
            </when>
            <when test="facilityDto.searchType == 'ADDRESS'">
                WHERE "ADDRESS" LIKE '%' || #{facilityDto.searchValue} || '%' 
                OR "REGION" LIKE '%' || #{facilityDto.searchValue} || '%'
            </when>
            <when test="facilityDto.searchType == 'YEAR_BULIT'">
                WHERE EXTRACT(YEAR FROM "YEAR_BUILT") = CAST(#{facilityDto.searchValue} AS INTEGER)
            </when>
        </choose>
        LIMIT ${size} OFFSET ${page}
    </select>
    
    <select id="getAllFacilityType" resultType="Dto.adg.BunryuDto">
        SELECT * FROM bunryu 
        WHERE "BCD" = 200 AND "MCD" != 999
    </select>
    
    <select id="getDamageTypeOfFacility" resultType="Dto.adg.BunryuDto">
        SELECT * FROM bunryu 
        WHERE "BCD" = ${facilityType} AND "MCD" != 999
    </select>
    
    <!-- 등록하고 등록된 시설물ID를 반환 -->
    <insert id="insertFacility" parameterType="Dto.adg.FacilityDto" useGeneratedKeys="true" keyProperty="facilityId">
	    INSERT INTO Facility (
	        "FACILITY_NAME", 
	        "FACILITY_TYPE", 
	        "FACILITY_SCALE",
	        "GEOM",
	        "REGION",
	        "ADDRESS",
	        "YEAR_BUILT"
	    ) VALUES (
	        #{facilityName},
	        #{facilityType},
	        #{facilityScale},
	        ST_GeomFromText('POINT(' || #{facilityGeomX} || ' ' || #{facilityGeomY} || ')', 5186),
	        #{region},
	        #{address},
	        #{yearBuilt}
	    )
	</insert>
</mapper>